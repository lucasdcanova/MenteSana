<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    
    <!-- Fix para iOS fullscreen (carregado o mais cedo possível) -->
    <script type="module">
      /**
       * iOS Production Fix - Correções específicas para dispositivos Apple em produção
       * Este script é carregado o mais cedo possível para garantir compatibilidade total
       * Versão 1.0.2
       */
      (function() {
        // Detecta dispositivo iOS
        const isIOS = /iphone|ipad|ipod|mac/.test(navigator.userAgent.toLowerCase()) ||
                     (navigator.platform && /iPad|iPhone|iPod|Mac/.test(navigator.platform)) ||
                     (navigator.maxTouchPoints && navigator.maxTouchPoints > 2 && /MacIntel/.test(navigator.platform));
        
        if (isIOS) {
          // Adiciona classe iOS no HTML para permitir estilos específicos
          document.documentElement.classList.add('ios-device');
          
          // Função para ajustar a altura em iOS para lidar com a barra de endereço
          function fixIOSHeight() {
            // Força o viewport a ser da altura da tela
            document.documentElement.style.height = '100%';
            document.body.style.height = '100%';
            
            // Usa -webkit-fill-available para garantir que a altura inclua toda a área disponível
            document.documentElement.style.height = '-webkit-fill-available';
            document.body.style.height = '-webkit-fill-available';
            
            // Impede comportamentos de rolagem não desejados
            document.body.style.overscrollBehavior = 'none';
          }
          
          // Executa imediatamente
          fixIOSHeight();
          
          // Executa quando o DOM estiver completamente carregado
          document.addEventListener('DOMContentLoaded', fixIOSHeight);
          
          // Executa após carregamento completo incluindo recursos
          window.addEventListener('load', fixIOSHeight);
          
          // Executa quando a orientação mudar
          window.addEventListener('orientationchange', function() {
            // Pequeno delay necessário para que o iOS tenha tempo de atualizar as dimensões
            setTimeout(fixIOSHeight, 300);
          });
          
          // Executa quando o tamanho da janela mudar
          window.addEventListener('resize', fixIOSHeight);
          
          // Técnica especial para prevenir o comportamento de "rubber-banding" (efeito elástico) em iOS
          document.addEventListener('touchmove', function(e) {
            if (e.touches.length > 1) {
              e.preventDefault();
            }
          }, { passive: false });
        }
      })();
    </script>
    <style>
      /* Estilos específicos para iOS */
      .ios-device {
        /* Evita efeito rubber-band no scroll */
        overscroll-behavior: none;
      }
      
      /* Ajustes para quando a página é adicionada à tela inicial */
      @media (display-mode: standalone), (display-mode: fullscreen) {
        body {
          /* Adiciona padding para área segura em notch/bordas arredondadas */
          padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        
        /* Corrige altura quando teclado aparece */
        @supports (-webkit-touch-callout: none) {
          .input-active {
            padding-bottom: 20vh;
          }
        }
      }
      
      /* Otimizações de toque para iOS */
      .ios-touch-fix {
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
      }
      
      /* Aceleração de hardware para animações mais suaves */
      .hardware-accelerated {
        transform: translateZ(0);
        -webkit-transform: translateZ(0);
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
        perspective: 1000;
        -webkit-perspective: 1000;
      }
    </style>
    
    <!-- Viewport otimizado para iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover, user-scalable=no, minimal-ui, shrink-to-fit=no" />
    
    <!-- Configurações avançadas para PWA em iOS - otimizado para fullscreen -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="MenteSã" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-touch-fullscreen" content="yes" />
    
    <!-- Para App Store e validação de app iOS -->
    <meta name="apple-itunes-app" content="app-id=com.mentesa.app" />
    <meta name="application-name" content="MenteSã" />
    <meta name="theme-color" content="#2a6451" media="(prefers-color-scheme: light)" />
    <meta name="theme-color" content="#1a4d3d" media="(prefers-color-scheme: dark)" />
    <meta name="description" content="Plataforma de saúde mental e bem-estar emocional" />
    <meta name="format-detection" content="telephone=no, email=no, address=no, date=no" />
    <meta name="mobile-web-app-capable" content="yes" />
    
    <!-- Impedir comportamento de hover e atraso no toque para iOS -->
    <meta name="msapplication-tap-highlight" content="no" />
    <meta name="apple-touch-fullscreen" content="yes" />
    
    <!-- Ícones para iOS -->
    <link rel="apple-touch-icon" href="/icons/apple-icon-180.svg" />
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/apple-icon-152.svg" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-icon-180.svg" />
    <link rel="apple-touch-icon" sizes="167x167" href="/icons/apple-icon-167.svg" />
    
    <!-- Telas de inicialização para iOS (atualizadas para os modelos mais recentes) -->
    <!-- iPad Pro 12.9" (6ª geração) -->
    <link rel="apple-touch-startup-image" href="/splash/apple-splash-2048-2732.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" />
    <!-- iPad Pro 11" (4ª geração) -->
    <link rel="apple-touch-startup-image" href="/splash/apple-splash-1668-2388.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" />
    <!-- iPad 10ª geração -->
    <link rel="apple-touch-startup-image" href="/splash/apple-splash-1536-2048.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" />
    <!-- iPhone 14/15 Pro, iPhone 13 Pro, iPhone 12 Pro -->
    <link rel="apple-touch-startup-image" href="/splash/apple-splash-1125-2436.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" />
    <!-- iPhone 14/15 Pro Max, iPhone 13 Pro Max, iPhone 12 Pro Max -->
    <link rel="apple-touch-startup-image" href="/splash/apple-splash-1242-2688.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" />
    <!-- iPhone 11, XR, 11 -->
    <link rel="apple-touch-startup-image" href="/splash/apple-splash-750-1334.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" />
    <!-- iPhone SE -->
    <link rel="apple-touch-startup-image" href="/splash/apple-splash-640-1136.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" />
    
    <!-- Web App Manifest -->
    <link rel="manifest" crossorigin="use-credentials" href="/manifest.json" />
    
    <!-- Script de otimização para PWA iOS -->
    <script type="module">
      /**
       * iOS Fullscreen - Garante execução em tela cheia em dispositivos iOS
       * Versão 1.2.0
       * 
       * Este script melhora a experiência quando o aplicativo é adicionado à tela inicial
       * em dispositivos iOS, garantindo que o app funcione em modo fullscreen e 
       * com comportamentos nativos como um aplicativo nativo
       */
      (function() {
        // Detecta iOS - combina várias técnicas para maior precisão
        const isIOS = /iphone|ipad|ipod|mac/.test(navigator.userAgent.toLowerCase()) ||
                     (navigator.platform && /iPad|iPhone|iPod|Mac/.test(navigator.platform)) ||
                     (navigator.maxTouchPoints && navigator.maxTouchPoints > 2 && /MacIntel/.test(navigator.platform));
        
        // Detecta se o app está em modo standalone (adicionado à tela inicial)
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
                            window.navigator.standalone === true;
        
        // Se não for iOS ou não estiver em modo standalone, encerra execução
        if (!isIOS) return;
        
        // Adiciona classe para sinalizar que estamos em um dispositivo iOS
        document.documentElement.classList.add('ios-device');
        
        if (isStandalone) {
          document.documentElement.classList.add('ios-standalone');
        }
        
        // Esta função lida com a inicialização em modo fullscreen
        function setupIOSFullscreen() {
          // Conjunto de técnicas para garantir fullscreen
          
          // 1. Aplica viewport com melhor configuração para iOS
          const viewportMeta = document.querySelector('meta[name="viewport"]');
          if (viewportMeta) {
            viewportMeta.setAttribute('content', 
              'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, minimal-ui');
          }
          
          // 2. Redefine altura para garantir que o aplicativo ocupe toda a tela
          function setFullHeight() {
            // Técnicas específicas para iOS para garantir altura total
            document.documentElement.style.height = '100vh';
            document.body.style.height = '100vh';
            
            // Safari em iOS se comporta melhor com esta propriedade
            document.documentElement.style.height = '-webkit-fill-available';
            document.body.style.height = '-webkit-fill-available';
            
            // Melhora a experiência com o teclado
            if (isStandalone) {
              // Manipulação de altura dinâmica quando em standalone
              const viewportHeight = window.innerHeight;
              document.documentElement.style.minHeight = `${viewportHeight}px`;
              document.body.style.minHeight = `${viewportHeight}px`;
            }
          }
          
          // Executa a função em momentos estratégicos
          setFullHeight();
          window.addEventListener('resize', setFullHeight);
          window.addEventListener('orientationchange', () => {
            // Delay para garantir que a orientação já foi alterada
            setTimeout(setFullHeight, 150);
          });
          
          // 3. Impede gestos nativos do iOS que podem interferir na experiência
          if (isStandalone) {
            // Previne o movimento de passar o dedo da borda para ativar controles do iOS
            document.addEventListener('touchstart', function(e) {
              // Verifica se o toque está perto da borda
              const touchX = e.touches[0].clientX;
              const touchY = e.touches[0].clientY;
              const edgeSize = 20; // pixels da borda
              
              if (
                touchX <= edgeSize || // borda esquerda
                touchX >= window.innerWidth - edgeSize || // borda direita
                touchY <= edgeSize || // borda superior
                touchY >= window.innerHeight - edgeSize // borda inferior
              ) {
                // Previne comportamento nativo apenas perto das bordas
                e.preventDefault();
              }
            }, { passive: false });
          }
        }
        
        // Detecta e corrige problemas de altura em iOS após o carregamento do DOM
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', setupIOSFullscreen);
        } else {
          setupIOSFullscreen();
        }
        
        // Aplicar novamente na carga completa para garantir
        window.addEventListener('load', setupIOSFullscreen);
      })();
    </script>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png" />
    
    <!-- Precarregamento de recursos críticos para performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    
    <!-- Estilos inline críticos para evitar FOUC (Flash of Unstyled Content) -->
    <style>
      html, body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        touch-action: manipulation;
        -webkit-overflow-scrolling: touch;
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
        /* Garantindo que a página ocupe toda a área disponível */
        position: fixed;
      }
      #root {
        height: 100%;
        width: 100%;
        overflow: hidden;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }
      /* Estilo específico para PWA instalado */
      @media (display-mode: standalone) {
        body {
          padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
      }
      /* Estilos específicos para iOS em modo PWA */
      html.ios-pwa {
        /* Garante altura total da tela em iOS */
        height: 100vh; 
        height: -webkit-fill-available;
        /* Impede que a barra de endereço apareça */
        overflow: hidden;
        position: fixed;
        width: 100%;
      }
      
      html.ios-pwa body {
        /* Impede comportamentos de rolagem que podem acionar a UI */
        overscroll-behavior: none;
        /* Força a aplicação a ocupar toda a tela */
        position: fixed;
        height: 100%;
        width: 100%;
      }
      
      /* Garante que não haverá bordas brancas */
      html.standalone-mode, 
      html.standalone-mode body,
      html.standalone-mode #root {
        background-color: #2a6451;
      }
    </style>
    
    <title>Mente Sã</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    
    <!-- Prevenção de contexto iOS para links externos -->
    <script type="module">
      // Esta função mantém links dentro do aplicativo em vez de abrir Safari
      (function() {
        function handleExternalLinks() {
          const isInStandaloneMode = window.matchMedia('(display-mode: standalone)').matches ||
                                    (window.navigator.standalone === true);
          if (isInStandaloneMode) {
            document.addEventListener('click', function(e) {
              let target = e.target;
              while (target && target.tagName !== 'A') {
                target = target.parentElement;
              }
              
              if (target && target.tagName === 'A' && target.getAttribute('target') === '_blank') {
                const newWindow = window.open(target.href, '_blank');
                e.preventDefault();
                // Se o navegador bloquear o popup, tente abrir na mesma janela
                if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                  window.location.href = target.href;
                }
              }
            });
          }
        }
        
        if (document.readyState === 'complete') {
          handleExternalLinks();
        } else {
          window.addEventListener('load', handleExternalLinks);
        }
      })();
    </script>
    
    <!-- Registro do Service Worker com atualização automática -->
    <script type="module">
      if ('serviceWorker' in navigator) {
        let refreshing = false;
        
        // Detecta quando o service worker é atualizado
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          if (!refreshing) {
            refreshing = true;
            window.location.reload();
          }
        });
        
        window.addEventListener('load', async () => {
          try {
            // Registra o service worker com verificação periódica de atualizações
            const registration = await navigator.serviceWorker.register('/sw.js', {
              scope: '/',
              updateViaCache: 'none'
            });
            
            console.log('Service Worker registrado com sucesso:', registration.scope);
            
            // Verifica atualizações a cada 60 minutos (em milissegundos)
            setInterval(() => {
              registration.update();
              console.log('Verificando atualizações do Service Worker...');
            }, 60 * 60 * 1000);
            
          } catch (error) {
            console.error('Falha ao registrar o Service Worker:', error);
          }
        });
      }
    </script>
    
    <!-- Detecção avançada de modo standalone e fullscreen para iOS -->
    <script type="module">
      (function() {
        // Função que será executada tanto na carga inicial quanto em intervalos regulares
        function detectStandaloneMode() {
          // Detecta standalone mode de várias maneiras
          const inStandaloneMode = 
            window.matchMedia('(display-mode: standalone)').matches || 
            window.matchMedia('(display-mode: fullscreen)').matches ||
            window.navigator.standalone === true ||
            document.referrer.includes('android-app://') ||
            localStorage.getItem('forceStandaloneMode') === 'true';
          
          // Detecta dispositivo iOS (inclui iPad que se identifica como desktop)
          const isIOS = 
            /iphone|ipad|ipod|mac/.test(navigator.userAgent.toLowerCase()) ||
            (navigator.platform && /iPad|iPhone|iPod|Mac/.test(navigator.platform)) ||
            (navigator.maxTouchPoints && navigator.maxTouchPoints > 2 && /MacIntel/.test(navigator.platform));
          
          if (inStandaloneMode) {
            // Adiciona classe de modo standalone
            document.documentElement.classList.add('standalone-mode');
            
            // Registra o estado no localStorage para persistência
            localStorage.setItem('forceStandaloneMode', 'true');
            
            console.log('Aplicativo rodando em modo standalone');
            
            // Específico para iOS: aplicar otimizações adicionais
            if (isIOS) {
              // Adiciona classe específica para iOS
              document.documentElement.classList.add('ios-pwa');
              
              // Configura estratégias específicas para iOS
              // Força o modo fullscreen para iOS
              const viewportMeta = document.querySelector('meta[name="viewport"]');
              if (viewportMeta) {
                viewportMeta.setAttribute('content', 
                  'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, minimal-ui, standalone'
                );
              }
              
              // Previne gestos de borda em todos os sentidos
              document.addEventListener('touchstart', function(e) {
                const touch = e.touches[0];
                if (touch) {
                  const x = touch.clientX;
                  const y = touch.clientY;
                  const edgeSize = 15; // Detecta gestos até 15px da borda
                  
                  if (
                    x <= edgeSize || // borda esquerda
                    x >= window.innerWidth - edgeSize || // borda direita
                    y <= edgeSize || // borda superior
                    y >= window.innerHeight - edgeSize // borda inferior
                  ) {
                    e.preventDefault();
                  }
                }
                
                // Previne gestos de pinça
                if (e.touches.length > 1) {
                  e.preventDefault();
                }
              }, {passive: false});
              
              // Previne gestos padrão do iOS
              document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
              }, {passive: false});
              
              document.addEventListener('gesturechange', function(e) {
                e.preventDefault();
              }, {passive: false});
              
              document.addEventListener('gestureend', function(e) {
                e.preventDefault();
              }, {passive: false});
              
              // Força height completo
              document.body.style.height = '100vh';
              document.body.style.height = '-webkit-fill-available';
              
              // Verifica em intervalo curto se o app continua em fullscreen
              setTimeout(detectStandaloneMode, 500);
            }
          }
        }
        
        // Executa imediatamente
        detectStandaloneMode();
        
        // Adiciona verificações para garantir que o modo fullscreen seja mantido
        window.addEventListener('resize', detectStandaloneMode);
        window.addEventListener('orientationchange', detectStandaloneMode);
        
        // Configura detecção contínua do modo standalone 
        setInterval(detectStandaloneMode, 2000);
      })();
    </script>
  </body>
</html>