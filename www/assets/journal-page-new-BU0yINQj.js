import{c as V,u as oe,a as ne,b as ie,d as ce,e as le,r as c,j as e,L as de,B as I,C as ue,f as me,g as pe,h as xe,i as he,P as J,k as fe,m as ge}from"./index-DKFI7ZyH.js";import{T as je}from"./textarea-CW1zArsP.js";import{T as ve,a as ye,b as K,c as W}from"./tabs-BarOwXjl.js";import{M as X}from"./mic-bIjlhTB5.js";import{M as Te}from"./mic-off-DUnMtqfr.js";import{I as we}from"./info-CRC729Dm.js";import{S as Q}from"./save-DXxBTbN0.js";import{T as be}from"./trash-B_pc7RHv.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=V("BookText",[["path",{d:"M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H19a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1H6.5a1 1 0 0 1 0-5H20",key:"k3hazp"}],["path",{d:"M8 11h8",key:"vwpz6n"}],["path",{d:"M8 7h6",key:"1f0q6e"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Re=V("Text",[["path",{d:"M17 6.1H3",key:"wptmhv"}],["path",{d:"M21 12.1H3",key:"1j38uz"}],["path",{d:"M15.1 18H3",key:"1nb16a"}]]);function De(){const{user:R}=oe(),S=ne(),{toast:u}=ie(),[Se,G]=ce(),{t}=le(),[j,_]=c.useState("audio"),[v,k]=c.useState(!1),[Y,O]=c.useState(0),[h,D]=c.useState(null),[Z,z]=c.useState(null),[E,C]=c.useState(!1),[ee,x]=c.useState(0),[L,P]=c.useState(""),[A,F]=c.useState(""),[$,U]=c.useState(!1),f=c.useRef(null),M=c.useRef([]),m=c.useRef(null),y=c.useRef(!1),B=c.useRef(null);c.useEffect(()=>{const d=navigator.userAgent||navigator.vendor;y.current=/iPad|iPhone|iPod/.test(d)&&!window.MSStream,y.current&&(console.log("Dispositivo iOS detectado - usando configurações otimizadas"),document.documentElement.classList.add("ios-device"))},[]),c.useEffect(()=>()=>{m.current&&clearInterval(m.current),h&&URL.revokeObjectURL(h),f.current&&f.current.state==="recording"&&f.current.stop(),B.current&&B.current.close()},[h]);const te=async()=>{try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("API MediaDevices não suportada neste navegador");const d={audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}};console.log("Solicitando acesso ao microfone...");const r=await navigator.mediaDevices.getUserMedia(d);console.log("Acesso ao microfone concedido!"),M.current=[];let s="audio/webm";if(y.current){console.log("Usando configurações especiais para iOS");const a=["audio/mp4","audio/aac","audio/x-m4a","audio/webm"];for(const n of a)if(MediaRecorder.isTypeSupported(n)){s=n,console.log(`Formato suportado encontrado: ${s}`);break}}else MediaRecorder.isTypeSupported("audio/webm")&&(s="audio/webm");console.log(`Usando formato de gravação: ${s}`);const o=new MediaRecorder(r,{mimeType:s});f.current=o,o.ondataavailable=a=>{a.data.size>0&&M.current.push(a.data)},o.onstop=async()=>{const a=s;console.log(`Criando blob de áudio com tipo: ${a}`);const n=new Blob(M.current,{type:a});console.log(`Blob de áudio criado, tamanho: ${(n.size/1024).toFixed(2)} KB`),z(n);const i=URL.createObjectURL(n);D(i),m.current&&(clearInterval(m.current),m.current=null),r.getTracks().forEach(l=>l.stop()),setTimeout(()=>{u({title:t("journal.autoTranscribing"),description:t("journal.pleaseWait")}),re(n)},500)},o.start(),k(!0),O(0),m.current=setInterval(()=>{O(a=>a+1)},1e3)}catch(d){console.error("Erro ao iniciar gravação:",d),u({title:t("journal.errors.microphoneAccessFailedTitle"),description:t("journal.errors.microphoneAccessFailedDesc"),variant:"destructive"})}},se=()=>{f.current&&f.current.state==="recording"&&(f.current.stop(),k(!1))},q=()=>{h&&URL.revokeObjectURL(h),D(null),z(null),C(!1),x(0),P(""),F(""),k(!1),m.current&&(clearInterval(m.current),m.current=null),u({title:t("journal.actions.entryDiscarded"),description:t("journal.actions.startOver")})},ae=d=>{const r=Math.floor(d/60),s=d%60;return`${r.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`},re=async d=>{const r=d||Z;if(!r){u({title:t("journal.errors.noAudioRecorded"),description:t("journal.errors.tryAgain"),variant:"destructive"});return}C(!0),x(10);try{const s=new FormData;let o="webm";r.type.includes("mp4")||r.type.includes("m4a")?o="m4a":r.type.includes("aac")?o="aac":(r.type.includes("mpeg")||r.type.includes("mp3"))&&(o="mp3"),console.log(`Enviando arquivo de áudio para transcrição: tipo=${r.type}, tamanho=${Math.round(r.size/1024)}KB, extensão=${o}`),s.append("audio",r,`recording.${o}`),s.append("source","journal-page-new"),s.append("extension",o),s.append("mimeType",r.type),s.append("timestamp",Date.now().toString());const a=localStorage.getItem("authToken");x(25);let n=null,i=1;const l=3;let b=null;for(;i<=l&&!n;){try{x(25+(i-1)*15),console.log(`Tentativa ${i}/${l}`);const T=new AbortController,N=setTimeout(()=>T.abort(),6e4),g=await fetch("/api/clean-transcribe",{method:"POST",headers:{Accept:"application/json",Authorization:a?`Bearer ${a}`:"","X-Requested-With":"XMLHttpRequest"},body:s,credentials:"include",signal:T.signal});if(clearTimeout(N),console.log(`Resposta da tentativa ${i}: status ${g.status}`),!g.ok){const p=await g.text();throw new Error(`Erro na resposta (${g.status}): ${p}`)}const w=await g.text();console.log(`Resposta de transcrição recebida (${w.length} bytes)`);try{const p=JSON.parse(w);if(console.log("Transcrição JSON:",p),p.text){n={transcription:p.text},x(90);break}else if(p.transcription){n=p,x(90);break}else throw new Error("Transcrição retornada vazia")}catch(p){if(console.warn("Resposta não é um JSON válido, usando como texto puro:",p),w&&w.trim().length>0){n={transcription:w.trim()},x(90);break}else throw new Error("Texto de transcrição vazio")}}catch(T){if(console.error(`Erro na tentativa ${i}:`,T),b=T,i<l){const N=i*2e3;console.log(`Aguardando ${N}ms antes da próxima tentativa...`),await new Promise(g=>setTimeout(g,N))}}i++}if(!n)throw b||new Error("Falha na transcrição após todas as tentativas");return x(100),P(n.transcription),u({title:t("journal.success.transcriptionComplete"),description:t("journal.savingAndRedirecting")}),setTimeout(()=>{H(n.transcription)},500),!0}catch(s){return console.error("Erro final na transcrição:",s),u({title:t("journal.errors.transcriptionFailedTitle"),description:s instanceof Error?s.message:t("journal.errors.transcriptionFailedDesc"),variant:"destructive"}),!1}finally{setTimeout(()=>{C(!1)},500)}},H=async d=>{const r=d||(j==="audio"?L:A);if(!r.trim()){u({title:t("journal.errors.emptyContentTitle"),description:t("journal.errors.emptyContentDesc"),variant:"destructive"});return}U(!0),console.log("Iniciando salvamento de entrada de diário...");try{const s={content:r,audioUrl:j==="audio"?h:null,hasAudio:j==="audio",needsProcessing:!0,mood:"neutro",userId:(R==null?void 0:R.id)||1};console.log("Dados da entrada preparados:",s);const o=localStorage.getItem("authToken");o?console.log("Token de autenticação disponível:",o.substring(0,10)+"..."):console.warn("Token de autenticação não encontrado!");const a=await fetch("/api/journal-entries",{method:"POST",headers:{"Content-Type":"application/json",Authorization:o?`Bearer ${o}`:"","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(s),credentials:"include"});if(console.log("Resposta do salvamento:",a.status),!a.ok){const l=await a.text();throw console.error("Erro na resposta:",a.status,l),new Error(`${t("journal.errors.saveFailed")} (${a.status})`)}const n=await a.text();let i;try{i=JSON.parse(n),console.log("Entrada salva com sucesso:",i)}catch(l){console.error("Erro ao parsear resposta:",l),console.log("Texto da resposta:",n)}try{if(i&&i.id){console.log("Iniciando processamento para entrada ID:",i.id);const l=await fetch(`/api/journal/${i.id}/process`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:o?`Bearer ${o}`:"","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({sendToOpenAI:!0,generateTitle:!0,categorize:!0,analyzeMood:!0}),credentials:"include"});if(l.ok)console.log("Processamento da entrada iniciado com sucesso");else{const b=await l.text();console.warn("Resposta de processamento não-OK:",l.status,b)}}else console.warn("ID da entrada não disponível para processamento")}catch(l){console.error("Erro ao iniciar processamento:",l)}q(),S.invalidateQueries({queryKey:["/api/journal-entries"]}),S.invalidateQueries({queryKey:["/api/journal-entries/user"]}),S.invalidateQueries({queryKey:["/api/journal-last-entry"]}),u({title:t("journal.success.title"),description:t("journal.success.entrySaved")}),setTimeout(()=>{G("/journal-history")},800)}catch(s){console.error("Erro ao salvar entrada:",s),u({title:t("journal.errors.saveFailedTitle"),description:s instanceof Error?s.message:t("journal.errors.saveFailedDesc"),variant:"destructive"})}finally{U(!1)}};return e.jsxs("div",{className:"container max-w-4xl mx-auto px-4 py-6 space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-2xl font-bold",children:t("journal.title")}),e.jsx(de,{href:"/journal-history",children:e.jsxs(I,{variant:"outline",size:"sm",className:"text-sm",children:[e.jsx(Ne,{className:"h-4 w-4 mr-2"}),t("journal.viewHistory")]})})]}),e.jsxs(ue,{className:y.current?"ios-card-style":"shadow-lg",children:[e.jsx(me,{className:"pb-0",children:e.jsx(pe,{children:t("journal.description")})}),e.jsx(xe,{className:"pt-6",children:e.jsxs(ve,{defaultValue:"audio",value:j,onValueChange:_,className:"w-full",children:[e.jsxs(ye,{className:"grid w-full grid-cols-2 mb-6",children:[e.jsxs(K,{value:"audio",className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-4 w-4"}),t("journal.tabs.audio")]}),e.jsxs(K,{value:"text",className:"flex items-center gap-2",children:[e.jsx(Re,{className:"h-4 w-4"}),t("journal.tabs.text")]})]}),e.jsxs(W,{value:"audio",className:"space-y-6",children:[!h&&!E&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-8 bg-muted/20 rounded-lg",children:[e.jsx("div",{className:`w-24 h-24 rounded-full flex items-center justify-center 
                      ${v?"bg-red-500 animate-pulse":"bg-primary hover:bg-primary/90"} 
                      cursor-pointer transition-colors duration-300 mb-4 shadow-lg`,onClick:v?se:te,children:v?e.jsx(Te,{className:"h-10 w-10 text-white"}):e.jsx(X,{className:"h-10 w-10 text-white"})}),v?e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"font-mono text-2xl",children:ae(Y)}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:t("journal.recording")})]}):e.jsx("p",{className:"text-center text-muted-foreground",children:t("journal.tapToRecord")}),y.current&&!v&&e.jsxs("div",{className:"mt-4 text-xs text-amber-600 max-w-xs text-center",children:[e.jsx(we,{className:"h-3 w-3 inline-block mr-1"}),t("journal.iosRecordingTip")]})]}),E&&e.jsxs("div",{className:"rounded-lg bg-muted/30 p-6 space-y-4",children:[e.jsxs("h3",{className:"font-medium text-center flex items-center justify-center",children:[e.jsx(he,{className:"h-5 w-5 mr-2 text-primary"}),t("journal.transcribing")]}),e.jsx(J,{value:ee,className:"w-full"}),e.jsx("p",{className:"text-sm text-center text-muted-foreground",children:t("journal.pleaseWait")})]}),L&&!E&&$&&e.jsxs("div",{className:"rounded-lg bg-muted/30 p-6 space-y-4",children:[e.jsxs("h3",{className:"font-medium text-center flex items-center justify-center",children:[e.jsx(Q,{className:"h-5 w-5 mr-2 text-primary"}),t("journal.actions.saving")]}),e.jsx(J,{value:75,className:"w-full"}),e.jsx("p",{className:"text-sm text-center text-muted-foreground",children:t("journal.savingAndRedirecting")})]})]}),e.jsx(W,{value:"text",className:"space-y-6",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(je,{placeholder:t("journal.textPlaceholder"),className:"min-h-[250px] resize-y",value:A,onChange:d=>F(d.target.value)}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs(I,{variant:"outline",onClick:q,className:"flex-1",children:[e.jsx(be,{className:"h-4 w-4 mr-2"}),t("journal.actions.discard")]}),e.jsx(I,{onClick:()=>H(),disabled:$||!A.trim(),className:"flex-1",children:$?e.jsxs(e.Fragment,{children:[e.jsx(fe,{className:"h-4 w-4 mr-2 animate-spin"}),t("journal.actions.saving")]}):e.jsxs(e.Fragment,{children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),t("journal.actions.save")]})})]})]})})]})})]}),e.jsxs(ge.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.2},className:"bg-muted/30 rounded-lg p-4 text-sm",children:[e.jsx("h3",{className:"font-medium mb-2",children:t("journal.howItWorks")}),e.jsxs("ol",{className:"list-decimal pl-5 space-y-1",children:[e.jsx("li",{children:t("journal.steps.recordOrType")}),j==="audio"?e.jsx("li",{children:t("journal.steps.autoSaveAudio")}):e.jsxs(e.Fragment,{children:[e.jsx("li",{children:t("journal.steps.reviewContent")}),e.jsx("li",{children:t("journal.steps.saveEntry")})]}),e.jsx("li",{children:t("journal.steps.checkHistory")})]})]})]})}export{De as default};
