import{c as F,j as e,B as g,b8 as L,bf as P,r as l,d as K,b as G,z as T,y as O,bv as b,I as y,J as z}from"./index-DKFI7ZyH.js";import{I as W}from"./ios-card-CPcYRIQQ.js";import{R}from"./refresh-cw-RqVKnbVz.js";import{S as _}from"./send-CMGarVcR.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $=F("WifiOff",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}],["path",{d:"M5 12.859a10 10 0 0 1 5.17-2.69",key:"1dl1wf"}],["path",{d:"M19 12.859a10 10 0 0 0-2.007-1.523",key:"4k23kn"}],["path",{d:"M2 8.82a15 15 0 0 1 4.177-2.643",key:"1grhjp"}],["path",{d:"M22 8.82a15 15 0 0 0-11.288-3.764",key:"z3jwby"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const U=F("Wifi",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["path",{d:"M5 12.859a10 10 0 0 1 14 0",key:"1x1e6c"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}]]),J=({error:t,errorType:r="unknown",isLoading:a=!1,retry:o,hideRetry:f=!1,customMessage:x,customAction:c})=>{if(!t&&!x)return null;const d=()=>{if(x)return x;if(t!=null&&t.message)return t.message;switch(r){case"network":return"Não foi possível conectar ao servidor. Verifique sua conexão de internet.";case"api":return"Ocorreu um erro ao processar sua solicitação. Por favor, tente novamente.";case"authentication":return"Sua sessão expirou. Por favor, faça login novamente.";case"authorization":return"Você não tem permissão para acessar este recurso.";case"ai":return"Não foi possível processar com IA no momento. Estamos utilizando análises alternativas.";default:return"Ocorreu um erro inesperado. Por favor, tente novamente."}},h=()=>{switch(r){case"network":return e.jsx($,{className:"w-12 h-12 text-destructive"});case"authentication":case"authorization":return e.jsx(P,{className:"w-12 h-12 text-destructive"});case"ai":return e.jsx(U,{className:"w-12 h-12 text-amber-500"});default:return e.jsx(P,{className:"w-12 h-12 text-destructive"})}};return e.jsx(W,{variant:"glass",className:"my-4 border-destructive/50 bg-destructive/5",children:e.jsxs("div",{className:"flex flex-col items-center p-6 text-center",children:[h(),e.jsx("h3",{className:"text-lg font-semibold mt-4 mb-2",children:"Ops!"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:d()}),e.jsxs("div",{className:"flex gap-3",children:[!f&&o&&e.jsx(g,{variant:"outline",onClick:o,disabled:a,className:"flex items-center gap-2",children:a?e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"w-4 h-4 animate-spin"}),e.jsx("span",{children:"Tentando novamente..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"w-4 h-4"}),e.jsx("span",{children:"Tentar novamente"})]})}),c&&e.jsx(g,{variant:"default",onClick:c.onClick,className:"flex items-center gap-2",children:c.label})]})]})})};function X(){const[t,r]=L.useState(navigator.onLine);return L.useEffect(()=>{const a=()=>r(!0),o=()=>r(!1);return window.addEventListener("online",a),window.addEventListener("offline",o),()=>{window.removeEventListener("online",a),window.removeEventListener("offline",o)}},[]),{isOnline:t}}class q extends Error{constructor(r="Erro de conexão com o servidor"){super(r),this.name="NetworkError"}}class N extends Error{constructor(r,a=500){super(r),this.name="APIError",this.status=a}}class D extends Error{constructor(r="Erro de autenticação"){super(r),this.name="AuthError"}}class Y extends Error{constructor(r="Serviço de IA indisponível"){super(r),this.name="AIServiceError"}}async function E(t,r={}){try{return await t()}catch(a){throw console.error("API call error:",a),a instanceof Error?"status"in a&&a.status===401?new D(r.authErrorMessage||"Sua sessão expirou. Por favor, faça login novamente."):a.message.includes("network")||a.message.includes("fetch")||a.message.includes("connection")?new q(r.networkErrorMessage||"Erro de conexão. Verifique sua internet."):a instanceof q||a instanceof N||a instanceof D||a instanceof Y?a:new N(r.errorMessage||a.message):new N(r.errorMessage||"Ocorreu um erro desconhecido")}}function ae(){const[t,r]=l.useState(""),[a,o]=l.useState(!1),f=l.useRef(null),x=l.useRef(null),c=l.useRef(null);K();const{toast:d}=G();l.useEffect(()=>{h(!1)},[]);const h=(s=!0)=>{f.current&&f.current.scrollIntoView({behavior:s?"smooth":"auto",block:"end"})},u=T({mutationFn:async s=>(await y("POST","/api/assistant/message",{message:s})).json(),onSuccess:()=>{z.invalidateQueries({queryKey:["/api/assistant/history"]}),setTimeout(()=>h(),100)},onError:()=>{d({title:"Erro ao enviar mensagem",description:"Não foi possível processar sua mensagem.",variant:"destructive"})}}),{isOnline:m}=X(),{data:i,isLoading:w,error:p,refetch:Q}=O({queryKey:["/api/assistant/history"],queryFn:async()=>await E(async()=>await(await y("GET","/api/assistant/history")).json(),{networkErrorMessage:"Não foi possível carregar o histórico de mensagens devido a problemas de conexão.",errorMessage:"Erro ao carregar o histórico de mensagens."}),retry:2,enabled:m}),{data:v,isLoading:j,error:k,refetch:V}=O({queryKey:["/api/assistant/greeting"],queryFn:async()=>await E(async()=>await(await y("GET","/api/assistant/greeting")).json(),{networkErrorMessage:"Não foi possível carregar a saudação inicial devido a problemas de conexão.",errorMessage:"Erro ao carregar a saudação do assistente."}),retry:2,enabled:m});l.useEffect(()=>{!w&&!j&&h()},[i,w,j]);const M=T({mutationFn:async()=>(await y("DELETE","/api/assistant/history"),!0),onSuccess:()=>{z.invalidateQueries({queryKey:["/api/assistant/history"]}),o(!1),d({title:"Conversa limpa",description:"O histórico foi apagado."})}}),C=l.useCallback(async()=>{if(!t.trim()||u.isPending)return;if(!m){d({title:"Sem conexão",description:"Você está offline. Conecte-se à internet para enviar mensagens.",variant:"destructive"});return}const s=t.trim();r("");try{await E(async()=>{await u.mutateAsync(s)},{networkErrorMessage:"Não foi possível enviar sua mensagem devido a problemas de conexão.",errorMessage:"Não foi possível processar sua mensagem. Tente novamente."})}catch(n){console.error("Erro ao enviar mensagem:",n),r(s)}},[t,u,m,d]),S=s=>{if(!s)return"";let n=s.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>");return n=n.replace(/\n\n/g,"<br><br>"),n=n.replace(/\n/g,"<br>"),n},B=s=>{r(s),c.current&&c.current.focus()};return e.jsxs("div",{className:"relative flex flex-col w-full h-[100dvh] bg-gray-50 overflow-hidden",children:[e.jsx("div",{ref:x,className:"flex-grow overflow-y-auto",style:{paddingTop:"env(safe-area-inset-top, 0px)",paddingBottom:"calc(4.5rem + env(safe-area-inset-bottom))"},children:e.jsx("div",{className:"px-3 py-2",children:w||j?e.jsx("div",{className:"flex justify-center items-center h-32",children:e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("div",{className:"h-2 w-2 bg-gray-300 rounded-full animate-pulse"}),e.jsx("div",{className:"h-2 w-2 bg-gray-300 rounded-full animate-pulse",style:{animationDelay:"200ms"}}),e.jsx("div",{className:"h-2 w-2 bg-gray-300 rounded-full animate-pulse",style:{animationDelay:"400ms"}})]})}):p||k?e.jsx(J,{error:p||k,errorType:m?(p==null?void 0:p.name)==="AIServiceError"?"ai":"api":"network",retry:()=>{Q(),V()},customMessage:m?void 0:"Você está offline. Conecte-se à internet para conversar com o assistente."}):e.jsxs("div",{className:"space-y-4",children:[!(i!=null&&i.length)&&(v==null?void 0:v.message)&&e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx("div",{className:"h-8 w-8 bg-primary/10 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(b,{className:"h-4 w-4 text-primary"})}),e.jsx("div",{className:"bg-white p-3 rounded-2xl rounded-tl-sm shadow-sm text-sm max-w-[80%]",dangerouslySetInnerHTML:{__html:S(v.message)}})]}),Array.isArray(i)&&i.map(s=>e.jsxs("div",{className:`flex items-start space-x-2 ${s.role==="user"?"flex-row-reverse space-x-reverse justify-start ml-auto":""}`,children:[s.role==="assistant"?e.jsx("div",{className:"h-8 w-8 bg-primary/10 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(b,{className:"h-4 w-4 text-primary"})}):e.jsx("div",{className:"h-8 w-8 bg-gray-100 rounded-full flex items-center justify-center flex-shrink-0 text-xs font-medium",children:s.userId.toString().charAt(0)}),e.jsx("div",{className:`p-3 rounded-2xl shadow-sm text-sm max-w-[80%] ${s.role==="user"?"bg-primary/10 rounded-tr-sm text-gray-800":"bg-white rounded-tl-sm text-gray-700"}`,dangerouslySetInnerHTML:{__html:S(s.content)}})]},s.id)),(()=>{var A;const s=Array.isArray(i)&&i.length>0?i[i.length-1]:null,n=(A=s==null?void 0:s.metadata)==null?void 0:A.followUpQuestions;return(s==null?void 0:s.role)==="assistant"&&Array.isArray(n)&&n.length>0?e.jsx("div",{className:"ml-10 my-2 flex flex-wrap gap-2",children:n.map((I,H)=>e.jsx("button",{className:"text-xs bg-gray-100 px-3 py-1.5 rounded-full text-gray-700 hover:bg-gray-200",onClick:()=>B(I),children:I},H))}):null})(),u.isPending&&e.jsxs("div",{className:"flex items-start space-x-2",children:[e.jsx("div",{className:"h-8 w-8 bg-primary/10 rounded-full flex items-center justify-center flex-shrink-0",children:e.jsx(b,{className:"h-4 w-4 text-primary"})}),e.jsx("div",{className:"bg-white p-3 rounded-2xl rounded-tl-sm shadow-sm",children:e.jsxs("div",{className:"flex space-x-1.5",children:[e.jsx("div",{className:"h-2 w-2 bg-gray-300 rounded-full animate-pulse"}),e.jsx("div",{className:"h-2 w-2 bg-gray-300 rounded-full animate-pulse",style:{animationDelay:"300ms"}}),e.jsx("div",{className:"h-2 w-2 bg-gray-300 rounded-full animate-pulse",style:{animationDelay:"600ms"}})]})})]}),e.jsx("div",{ref:f})]})})}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 z-50 pb-safe",children:e.jsx("div",{className:"bg-white border-t border-gray-200 p-3",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{ref:c,type:"text",value:t,onChange:s=>r(s.target.value),onKeyDown:s=>s.key==="Enter"&&C(),placeholder:"Mensagem...",className:"flex-1 h-12 rounded-full border border-gray-200 px-4 text-base focus:outline-none focus:ring-2 focus:ring-primary/30 shadow-sm",disabled:u.isPending}),e.jsx(g,{size:"icon",className:"ml-2 h-12 w-12 rounded-full bg-primary text-white shadow-sm hover:bg-primary/90 active:scale-95 transition-transform",onClick:C,disabled:!t.trim()||u.isPending,children:e.jsx(_,{className:"h-5 w-5"})})]})})}),a&&e.jsx("div",{className:"fixed inset-0 bg-black/30 flex items-center justify-center z-50 p-4 backdrop-blur-sm",children:e.jsxs("div",{className:"bg-white rounded-xl p-4 w-full max-w-[280px] shadow-lg",children:[e.jsx("p",{className:"text-center font-medium mb-4",children:"Limpar esta conversa?"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(g,{variant:"outline",className:"flex-1 text-sm h-10 rounded-xl",onClick:()=>o(!1),children:"Cancelar"}),e.jsx(g,{variant:"destructive",className:"flex-1 text-sm h-10 rounded-xl",onClick:()=>M.mutate(),disabled:M.isPending,children:"Limpar"})]})]})})]})}export{ae as default};
