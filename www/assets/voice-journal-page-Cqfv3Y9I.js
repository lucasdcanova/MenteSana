import{u as $,b as K,r,y as H,z as J,j as e,X as Q,B as k,k as G,I as M,J as V,K as X}from"./index-DKFI7ZyH.js";import{f as W}from"./formatDistanceToNow-CnNYJNjZ.js";import{M as q}from"./mic-bIjlhTB5.js";import"./endOfMonth-D7azNT7e.js";function oe(){var U;const{user:t}=$(),{toast:m}=K(),[n,x]=r.useState(!1),[w,d]=r.useState(0),[y,f]=r.useState(null),[o,h]=r.useState(null),[C,R]=r.useState(""),[P,Y]=r.useState("calmo"),[S,j]=r.useState(!0),[v,Z]=r.useState(2),c=r.useRef(null),b=r.useRef([]),i=r.useRef(null),{data:B=[]}=H({queryKey:["/api/journal"],enabled:!!t}),E=[...B].sort((s,l)=>new Date(l.date).getTime()-new Date(s.date).getTime()).slice(0,5),u=J({mutationFn:async({audioBlob:s,userId:l,text:a,mood:p,duration:F})=>{let D=null;if(s){const N=new FormData;N.append("audio",s,"journal-audio.wav"),N.append("userId",String(l));const T=await M("POST","/api/upload/audio",void 0,{body:N});if(!T.ok)throw new Error("Falha ao fazer upload do áudio");D=(await T.json()).audioUrl}return await(await M("POST","/api/journal",{userId:l,content:a||"Nota de voz",mood:p,audioUrl:D,audioDuration:F})).json()},onSuccess:()=>{V.invalidateQueries({queryKey:["/api/journal"]}),m({title:"Nota salva",description:"Sua anotação de voz foi salva com sucesso."}),f(null),h(null),R(""),d(0)},onError:s=>{console.error("Erro ao salvar nota:",s),m({title:"Erro ao salvar nota",description:s.message,variant:"destructive"})}});r.useEffect(()=>()=>{i.current&&clearInterval(i.current),o&&URL.revokeObjectURL(o)},[o]);const I=async()=>{try{const s=await navigator.mediaDevices.getUserMedia({audio:!0}),l=new MediaRecorder(s);c.current=l,b.current=[],l.ondataavailable=a=>{a.data.size>0&&b.current.push(a.data)},l.onstop=()=>{const a=new Blob(b.current,{type:"audio/wav"});f(a);const p=URL.createObjectURL(a);h(p)},l.start(),x(!0),d(0),i.current=window.setInterval(()=>{d(a=>a+1)},1e3),j(!1)}catch(s){console.error("Erro ao iniciar a gravação:",s),m({title:"Erro ao iniciar gravação",description:"Não foi possível acessar o microfone.",variant:"destructive"})}},L=()=>{c.current&&n&&(c.current.stop(),x(!1),i.current&&(clearInterval(i.current),i.current=null),c.current.stream.getTracks().forEach(s=>s.stop()),j(!0))},z=()=>{t&&y&&u.mutateAsync({audioBlob:y,userId:t.id,text:C||"Nota de voz",mood:P,duration:w})},A=()=>{c.current&&n&&(c.current.stop(),c.current.stream.getTracks().forEach(s=>s.stop()),i.current&&(clearInterval(i.current),i.current=null)),x(!1),f(null),o&&(URL.revokeObjectURL(o),h(null)),d(0),R(""),j(!0)},O=s=>{const l=Math.floor(s/60),a=s%60;return`${l}:${a<10?"0":""}${a}`},g=new Date;return e.jsxs("div",{className:"flex flex-col min-h-screen bg-black text-white",children:[e.jsxs("div",{className:"flex justify-between items-center p-6 pt-10 pb-2",children:[e.jsx("div",{className:"flex flex-col",children:e.jsxs("div",{className:"text-xl font-bold",children:[g.getHours(),":",g.getMinutes()<10?"0":"",g.getMinutes()]})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:"w-4 h-4 bg-white rounded-full"}),e.jsx("div",{className:"w-4 h-4 bg-white rounded-full"}),e.jsx("div",{className:"w-4 h-4 bg-white rounded-full"}),e.jsx("div",{className:"w-4 h-4 bg-white rounded-full"})]}),e.jsx("button",{className:"text-white",children:e.jsx(Q,{className:"h-6 w-6"})})]}),e.jsxs("div",{className:"flex-1 p-6 pt-2 overflow-auto flex flex-col",children:[e.jsxs("div",{className:"flex items-start mb-4",children:[e.jsx("div",{className:"w-12 h-12 bg-teal-400 rounded-full overflow-hidden mr-3",children:t!=null&&t.profilePicture?e.jsx("img",{src:t.profilePicture,alt:t.firstName,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center bg-teal-400 text-white text-xl font-bold",children:((U=t==null?void 0:t.firstName)==null?void 0:U[0])||"U"})}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-4xl font-bold mb-1",children:["Hey ",(t==null?void 0:t.firstName)||"você",","]}),e.jsx("h2",{className:"text-4xl font-bold mb-6",children:"o que posso ajudar?"}),S&&e.jsxs("div",{className:"text-teal-400 mb-6",children:[v," ",v===1?"Solicitação":"Solicitações"," em progresso"]})]})]}),S&&E.length>0&&e.jsx("div",{className:"mb-8 space-y-2",children:E.slice(0,v).map(s=>e.jsxs("div",{className:"bg-gray-900 rounded-xl p-4 mb-2 border border-gray-800",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsx("div",{className:"text-sm text-gray-400",children:W(new Date(s.date),{locale:X,addSuffix:!0})}),e.jsx("div",{className:"px-2 py-1 rounded-full bg-gray-800 text-xs",children:s.mood})]}),e.jsx("p",{className:"mb-2 text-gray-200",children:s.content}),s.audioUrl&&e.jsx("audio",{src:s.audioUrl,controls:!0,className:"w-full h-10 mt-2"})]},s.id))}),n&&e.jsx("div",{className:"flex flex-col items-center justify-center flex-1",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-pulse flex items-center justify-center h-24 w-24 rounded-full bg-teal-900 mb-4",children:e.jsx(q,{className:"h-12 w-12 text-teal-400"})}),e.jsx("p",{className:"text-2xl font-bold mb-2",children:O(w)}),e.jsx("p",{className:"text-gray-400",children:"Gravando..."})]})}),o&&!n&&e.jsx("div",{className:"my-4",children:e.jsxs("div",{className:"bg-gray-900 rounded-xl p-4 border border-gray-800",children:[e.jsx("audio",{src:o,controls:!0,className:"w-full mb-3"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(k,{onClick:A,variant:"outline",className:"flex-1 border-gray-700 text-white hover:bg-gray-800",children:"Descartar"}),e.jsx(k,{onClick:z,className:"flex-1 bg-teal-600 hover:bg-teal-700 text-white",disabled:u.isPending,children:u.isPending?e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"mr-2 h-4 w-4 animate-spin"}),"Salvando..."]}):"Salvar Nota"})]})]})})]}),e.jsx("div",{className:"p-6 pb-8 border-t border-gray-900",children:e.jsx("div",{className:"relative",children:e.jsxs("div",{className:"flex items-center bg-gray-900 p-4 rounded-full border border-gray-800",children:[e.jsx("input",{type:"text",className:"flex-1 bg-transparent outline-none text-gray-300 placeholder-gray-500",placeholder:"Comece a escrever ou falar...",disabled:n||!!o}),e.jsx("button",{className:`ml-2 w-12 h-12 rounded-full flex items-center justify-center ${n?"bg-red-600 hover:bg-red-700":"bg-teal-600 hover:bg-teal-700"}`,onClick:n?L:I,disabled:!!o||u.isPending,children:e.jsx(q,{className:"h-6 w-6 text-white"})})]})})}),e.jsxs("div",{className:"flex justify-center pb-8",children:[e.jsx("div",{className:"w-8 h-1 bg-gray-700 rounded-full mx-1"}),e.jsx("div",{className:"w-8 h-1 bg-gray-700 rounded-full mx-1"})]})]})}export{oe as default};
