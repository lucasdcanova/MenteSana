import{c as J,b4 as pe,d as xe,u as ge,b as be,r,y as R,z as ve,j as e,B as h,b5 as Ne,i as we,aN as je,b6 as ye,I as ke}from"./index-DKFI7ZyH.js";import{D as Se,d as Ee,a as Ce,e as Te,b as $e}from"./dialog-B2iG5lPB.js";import{T as De}from"./textarea-CW1zArsP.js";import{M as Me}from"./maximize-Cz77RMtR.js";import{M as Ve}from"./mic-off-DUnMtqfr.js";import{M as Oe}from"./mic-bIjlhTB5.js";import{V as Ie}from"./video-CdR5eL6v.js";import{P as Pe}from"./phone-1GZSxC6s.js";import{M as Le}from"./message-square-COtO5yp6.js";/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Re=J("EllipsisVertical",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]]);/**
 * @license lucide-react v0.453.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ze=J("VideoOff",[["path",{d:"M10.66 6H14a2 2 0 0 1 2 2v2.5l5.248-3.062A.5.5 0 0 1 22 7.87v8.196",key:"w8jjjt"}],["path",{d:"M16 16a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2",key:"1xawa7"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);function Ge(){var _,K;const{id:x}=pe(),[We,j]=xe(),{user:a}=ge(),{toast:m}=be(),[V,O]=r.useState(!1),[H,y]=r.useState(!0),[k,B]=r.useState(!1),[w,z]=r.useState(!1),[I,W]=r.useState(!1),[q,u]=r.useState([]),[E,A]=r.useState(""),[P,Q]=r.useState(null),[qe,L]=r.useState(!1),[C,Y]=r.useState(null),[g,G]=r.useState(null),[T,X]=r.useState(0),[Ae,U]=r.useState(!1),n=r.useRef(null),$=r.useRef(null),{data:b,isLoading:Z,error:ee}=R({queryKey:[`/api/sessions/${x}`]}),{data:D,isLoading:se,error:ae}=R({queryKey:[`/api/video/status?sessionId=${x}`],enabled:!!x}),{data:S,isLoading:te,error:oe}=R({queryKey:[`/api/video/token?sessionId=${x}`]});r.useEffect(()=>{S&&S.token&&(Y(S.token),console.log("Twilio token received:",S.token.substring(0,10)+"..."))},[S]);const re=Z||se||te,ie=ee||ae||oe;r.useEffect(()=>{D&&(G(D),console.log("Room status:",D))},[D]);const c={firstName:((_=b==null?void 0:b.therapistName)==null?void 0:_.split(" ")[0])||"Terapeuta",lastName:((K=b==null?void 0:b.therapistName)==null?void 0:K.split(" ")[1])||"",specialization:"Terapeuta Online"};r.useEffect(()=>{if(!a||!x)return;const o=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws`,i=new WebSocket(o);return i.onopen=()=>{console.log("WebSocket connected"),L(!0),i.send(JSON.stringify({type:"identify",userId:a.id,callId:x,userName:`${a.firstName} ${a.lastName}`})),u(l=>[...l,{sender:"Sistema",message:"Conexão com chat estabelecida",timestamp:new Date}])},i.onmessage=l=>{try{const t=JSON.parse(l.data);switch(console.log("Received message:",t),t.type){case"chat":u(d=>[...d,{sender:t.senderName||"Terapeuta",message:t.message,timestamp:new Date(t.timestamp)}]);break;case"info":u(d=>[...d,{sender:"Sistema",message:t.message,timestamp:new Date}]);break;case"connectionStatus":console.log("Status de conexão atualizado:",t.status),t.status==="connected"&&(m({title:"Conectado ao chat",description:"Você está conectado ao chat da sessão"}),t.participants&&t.participants.length>0&&u(d=>[...d,{sender:"Sistema",message:`${t.participants.length} participante(s) já na chamada`,timestamp:new Date}]));break;case"participantJoined":u(d=>[...d,{sender:"Sistema",message:`${t.userName||"Um novo participante"} entrou na chamada`,timestamp:new Date}]);break;case"participantLeft":u(d=>[...d,{sender:"Sistema",message:`${t.userName||"Um participante"} saiu da chamada`,timestamp:new Date}]);break;case"videoSignal":console.log("Sinal de vídeo recebido do usuário:",t.senderId);break;case"notification":m({title:t.title||"Notificação",description:t.message});break}}catch(t){console.error("Error parsing WebSocket message:",t)}},i.onerror=l=>{console.error("WebSocket error:",l),L(!1),m({title:"Erro de Conexão",description:"Erro na conexão do chat. Algumas funcionalidades podem estar indisponíveis.",variant:"destructive"})},i.onclose=()=>{console.log("WebSocket connection closed"),L(!1)},Q(i),()=>{i&&i.readyState===WebSocket.OPEN&&i.close()}},[a,x,m]),r.useEffect(()=>{let s;return V&&(s=setInterval(()=>{X(o=>o+1)},1e3)),()=>{s&&clearInterval(s)}},[V]);const ne=r.useCallback(()=>{const s=Math.floor(T/3600),o=Math.floor(T%3600/60),i=T%60;return`${s>0?`${s}:`:""}${o.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`},[T]),ce=r.useCallback(()=>{document.fullscreenElement?document.exitFullscreen&&(document.exitFullscreen(),U(!1)):(document.documentElement.requestFullscreen().catch(s=>{console.error(`Erro ao entrar em tela cheia: ${s.message}`)}),U(!0))},[]);r.useEffect(()=>{if(!b||!C||!g)return;let s,o=null;return(async()=>{try{if(console.log("Iniciando configuração do Twilio Video..."),!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Seu navegador não suporta acesso à câmera e microfone. Por favor, atualize para uma versão mais recente.");const l=await navigator.mediaDevices.enumerateDevices(),t=l.some(p=>p.kind==="videoinput"),d=l.some(p=>p.kind==="audioinput");if(console.log(`Dispositivos encontrados: Câmera: ${t}, Microfone: ${d}`),!t&&!d)throw new Error("Nenhuma câmera ou microfone encontrado no seu dispositivo.");try{o=await navigator.mediaDevices.getUserMedia({video:t,audio:d}),console.log("Acesso concedido à câmera e/ou microfone")}catch(p){if(console.error("Erro ao acessar câmera e microfone:",p),d){console.log("Tentando apenas microfone como fallback...");try{o=await navigator.mediaDevices.getUserMedia({video:!1,audio:!0}),console.log("Acesso concedido apenas ao microfone"),m({title:"Apenas áudio disponível",description:"Não foi possível acessar sua câmera, mas o microfone está funcionando.",variant:"destructive"}),z(!0)}catch(M){throw console.error("Erro ao acessar apenas o microfone:",M),new Error("Não foi possível acessar seu microfone. Por favor, verifique as permissões.")}}else throw new Error("Não foi possível acessar sua câmera ou microfone. Por favor, verifique as permissões.")}o&&n.current&&(n.current.srcObject=o,console.log("Stream de mídia local configurado com sucesso")),console.log("Conectando ao serviço Twilio Video..."),console.log("Token:",C.substring(0,20)+"..."),console.log("Sala:",g.roomName),y(!0);try{ye(()=>import("https://sdk.twilio.com/js/video/releases/2.26.0/twilio-video.min.js"),[]).then(p=>{window.Twilio.Video.connect(C,{name:g.roomName,audio:d,video:t,dominantSpeaker:!0}).then(v=>{console.log(`Conectado à sala: ${v.name}`),window.twilioRoom=v,y(!1),O(!0),m({title:"Conectado",description:`Você está conectado com ${c.firstName} ${c.lastName}`}),u(f=>[...f,{sender:"Sistema",message:"Conexão de vídeo estabelecida com sucesso!",timestamp:new Date}]),g.otherParticipantConnected&&u(f=>[...f,{sender:"Sistema",message:`${c.firstName} ${c.lastName} já está na chamada.`,timestamp:new Date}]),v.localParticipant.tracks.forEach(f=>{f.track&&f.track.attach(n.current)}),v.participants.forEach(f=>{f.tracks.forEach(N=>{N.track&&N.track.attach($.current)})}),v.on("participantConnected",f=>{console.log(`Participante conectado: ${f.identity}`),u(N=>[...N,{sender:"Sistema",message:`${c.firstName} ${c.lastName} entrou na chamada.`,timestamp:new Date}]),f.tracks.forEach(N=>{N.track&&N.track.attach($.current)})}),v.on("trackPublished",(f,N)=>{f.on("subscribed",he=>{he.attach($.current)})})}).catch(v=>{console.error("Erro ao conectar à sala Twilio:",v),y(!1),m({title:"Erro de Conexão",description:"Não foi possível conectar à sala de vídeo. "+v.message,variant:"destructive"})})}).catch(p=>{console.error("Erro ao carregar SDK do Twilio:",p),y(!1),console.log("Usando modo de simulação como fallback"),s=setTimeout(()=>{O(!0),m({title:"Conectado (Modo Limitado)",description:`Você está em modo de conexão limitado com ${c.firstName} ${c.lastName}`}),u(M=>[...M,{sender:"Sistema",message:"Conexão em modo limitado estabelecida. Algumas funcionalidades podem não estar disponíveis.",timestamp:new Date}])},2e3)})}catch(p){console.error("Erro ao inicializar integração Twilio:",p),y(!1),m({title:"Modo de Compatibilidade",description:"Usando modo de compatibilidade para a videochamada.",variant:"destructive"}),s=setTimeout(()=>{O(!0)},2e3)}}catch(l){console.error("Erro ao configurar chamada de vídeo:",l),m({title:"Erro de Conexão",description:l instanceof Error?l.message:"Não foi possível acessar sua câmera ou microfone. Por favor, verifique as permissões.",variant:"destructive"}),y(!1)}})(),()=>{if(clearTimeout(s),n.current&&n.current.srcObject&&n.current.srcObject.getTracks().forEach(t=>t.stop()),console.log("Limpando recursos do Twilio Video"),window.twilioRoom)try{console.log("Desconectando da sala Twilio..."),window.twilioRoom.disconnect(),delete window.twilioRoom}catch(l){console.error("Erro ao desconectar da sala Twilio:",l)}}},[b,C,g,m,c.firstName,c.lastName]);const le=()=>{n.current&&n.current.srcObject&&(n.current.srcObject.getAudioTracks().forEach(i=>{i.enabled=k}),B(!k))},de=()=>{n.current&&n.current.srcObject&&(n.current.srcObject.getVideoTracks().forEach(i=>{i.enabled=w}),z(!w))},me=ve({mutationFn:async()=>{if(!(g!=null&&g.roomName))throw new Error("Nome da sala não disponível");return await(await ke("POST","/api/video/end",{roomName:g.roomName})).json()},onSuccess:()=>{console.log("Sala encerrada com sucesso no servidor"),n.current&&n.current.srcObject&&n.current.srcObject.getTracks().forEach(o=>o.stop()),m({title:"Chamada Encerrada",description:"Você saiu da chamada com sucesso"}),j("/")},onError:s=>{console.error("Erro ao encerrar a sala:",s),m({title:"Erro ao Encerrar Chamada",description:"Ocorreu um erro ao encerrar a chamada, mas você foi desconectado localmente.",variant:"destructive"}),n.current&&n.current.srcObject&&n.current.srcObject.getTracks().forEach(i=>i.stop()),j("/")}}),ue=()=>{me.mutate()},F=()=>{if(!E.trim())return;const s={sender:`${a==null?void 0:a.firstName} ${a==null?void 0:a.lastName}`,message:E,timestamp:new Date};u(o=>[...o,s]),P&&P.readyState===WebSocket.OPEN?(console.log("Enviando mensagem via WebSocket"),P.send(JSON.stringify({type:"chat",senderId:a==null?void 0:a.id,senderName:`${a==null?void 0:a.firstName} ${a==null?void 0:a.lastName}`,recipientId:parseInt(x),callId:x,message:E,timestamp:new Date().toISOString()}))):(console.log("WebSocket não está conectado, usando modo de fallback"),u(o=>[...o,{sender:"Sistema",message:"Sua mensagem foi enviada no modo offline. Alguns participantes podem não receber.",timestamp:new Date}]),setTimeout(()=>{const o={sender:`Dr. ${c.firstName} ${c.lastName}`,message:"Obrigado por compartilhar. Como isso faz você se sentir?",timestamp:new Date};u(i=>[...i,o])},3e3)),A("")},fe=s=>s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return a?re?e.jsxs("div",{className:"min-h-screen bg-primary flex flex-col items-center justify-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-dark"}),e.jsx("p",{className:"mt-4 text-primary-dark",children:"Preparando sua sessão de terapia..."})]}):ie||!b?e.jsxs("div",{className:"min-h-screen bg-primary flex flex-col items-center justify-center p-4",children:[e.jsx("div",{className:"text-red-500 text-5xl mb-4",children:"⚠️"}),e.jsx("h1",{className:"text-2xl font-bold text-secondary mb-2",children:"Sessão Não Encontrada"}),e.jsx("p",{className:"text-primary-dark mb-4 text-center",children:"Não foi possível encontrar a sessão de terapia que você está procurando. Ela pode ter sido cancelada ou remarcada."}),e.jsx(h,{className:"bg-primary-dark hover:bg-secondary",onClick:()=>j("/"),children:"Voltar para Página Inicial"})]}):e.jsxs("div",{className:"min-h-screen bg-secondary flex flex-col",children:[e.jsxs("div",{className:"bg-primary-dark text-white p-4 flex items-center justify-between rounded-b-xl shadow-md",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(h,{variant:"ghost",size:"sm",className:"text-white hover:bg-white/10 mr-2 rounded-full p-2",onClick:()=>j("/"),children:e.jsx(Ne,{className:"h-5 w-5"})}),e.jsx("div",{className:"w-10 h-10 rounded-full bg-accent flex items-center justify-center mr-3 shadow-sm",children:e.jsx("span",{className:"text-primary-dark font-medium",children:`${c.firstName[0]}${c.lastName[0]}`})}),e.jsxs("div",{children:[e.jsxs("h2",{className:"font-semibold",children:["Dr. ",c.firstName," ",c.lastName]}),e.jsx("p",{className:"text-xs opacity-80",children:c.specialization})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex items-center bg-black/20 px-3 py-1 rounded-full mr-1",children:[e.jsx(we,{className:"h-3 w-3 mr-1"}),e.jsx("span",{className:"text-xs font-medium",children:ne()})]}),V?e.jsxs("span",{className:"flex items-center text-xs bg-green-500/20 px-2 py-1 rounded-full",children:[e.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full mr-1"}),"Conectado"]}):H?e.jsxs("span",{className:"flex items-center text-xs bg-yellow-500/20 px-2 py-1 rounded-full",children:[e.jsx("span",{className:"w-2 h-2 bg-yellow-500 rounded-full mr-1 animate-pulse"}),"Conectando..."]}):e.jsxs("span",{className:"flex items-center text-xs bg-red-500/20 px-2 py-1 rounded-full",children:[e.jsx("span",{className:"w-2 h-2 bg-red-500 rounded-full mr-1"}),"Desconectado"]}),e.jsx(h,{variant:"ghost",size:"sm",className:"text-white hover:bg-white/10 rounded-full p-2",onClick:ce,children:e.jsx(Me,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"flex-1 flex flex-col relative",children:[e.jsxs("div",{className:"absolute inset-0 bg-black rounded-lg mx-2 my-2 overflow-hidden",children:[e.jsxs("video",{ref:$,className:"w-full h-full object-cover",autoPlay:!0,playsInline:!0,muted:!0,children:[e.jsx("source",{src:"https://assets.mixkit.co/videos/preview/mixkit-young-woman-talking-while-video-call-conference-at-home-42392-large.mp4",type:"video/mp4"}),"Your browser does not support video playback."]}),e.jsxs("div",{className:"absolute top-2 left-1/2 transform -translate-x-1/2 bg-black/70 rounded-full px-3 py-1 flex items-center",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-red-500 animate-pulse mr-1.5"}),e.jsx("span",{className:"text-white text-xs font-medium",children:"REC"})]})]}),e.jsxs("div",{className:"absolute bottom-20 right-4 w-1/3 max-w-[160px] rounded-2xl overflow-hidden shadow-lg z-10 border-[3px] border-white",style:{aspectRatio:"3/4",transform:"rotate(-1deg)"},children:[e.jsx("video",{ref:n,className:`w-full h-full object-cover ${w?"hidden":""}`,autoPlay:!0,playsInline:!0,muted:!0}),w&&e.jsx("div",{className:"bg-gray-800 w-full h-full flex items-center justify-center",children:e.jsx("div",{className:"w-16 h-16 rounded-full bg-primary-dark flex items-center justify-center shadow-inner",children:e.jsx("span",{className:"text-white text-xl font-semibold",children:a?`${a.firstName[0]}${a.lastName[0]}`:"Eu"})})}),e.jsx("div",{className:"absolute inset-0 bg-black/10 opacity-0 hover:opacity-100 transition-opacity",onTouchStart:s=>s.currentTarget.classList.add("bg-black/20"),onTouchEnd:s=>s.currentTarget.classList.remove("bg-black/20")})]}),I&&e.jsxs("div",{className:"absolute top-0 right-0 bottom-0 w-full md:w-80 bg-white shadow-lg z-20 flex flex-col",children:[e.jsxs("div",{className:"p-3 bg-primary-dark text-white flex justify-between items-center",children:[e.jsx("h3",{className:"font-semibold",children:"In-Call Messages"}),e.jsx(h,{variant:"ghost",size:"sm",className:"text-white hover:bg-primary-dark hover:bg-opacity-50 p-1 h-auto",onClick:()=>W(!1),children:"✕"})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-3 bg-gray-50",children:q.length===0?e.jsx("div",{className:"h-full flex items-center justify-center text-center text-gray-400 p-4",children:e.jsx("p",{children:"No messages yet. Start the conversation!"})}):q.map((s,o)=>e.jsxs("div",{className:`mb-3 max-w-[85%] ${s.sender.includes((a==null?void 0:a.firstName)||"")?"ml-auto":"mr-auto"}`,children:[e.jsx("div",{className:`rounded-lg p-2 ${s.sender.includes((a==null?void 0:a.firstName)||"")?"bg-primary-dark text-white rounded-br-none":"bg-gray-200 text-gray-800 rounded-bl-none"}`,children:s.message}),e.jsx("div",{className:`text-xs mt-1 ${s.sender.includes((a==null?void 0:a.firstName)||"")?"text-right":""}`,children:e.jsxs("span",{className:"text-gray-500",children:[s.sender," • ",fe(s.timestamp)]})})]},o))}),e.jsx("div",{className:"p-3 border-t border-gray-200",children:e.jsxs("div",{className:"flex",children:[e.jsx(je,{placeholder:"Type a message...",value:E,onChange:s=>A(s.target.value),onKeyDown:s=>s.key==="Enter"&&F(),className:"flex-1 mr-2 bg-gray-100"}),e.jsx(h,{className:"bg-primary-dark hover:bg-secondary",onClick:F,children:"Send"})]})})]})]}),e.jsxs("div",{className:"bg-black/80 backdrop-blur-md text-white p-4 mx-3 mb-4 rounded-2xl flex justify-evenly",children:[e.jsxs(h,{variant:"ghost",className:`rounded-full w-14 h-14 flex flex-col items-center justify-center gap-1 ${k?"bg-red-500/90 hover:bg-red-600/90":"bg-white/10 hover:bg-white/20"}`,onClick:le,children:[k?e.jsx(Ve,{className:"h-5 w-5"}):e.jsx(Oe,{className:"h-5 w-5"}),e.jsx("span",{className:"text-[10px] font-medium",children:k?"Unmute":"Mute"})]}),e.jsxs(h,{variant:"ghost",className:`rounded-full w-14 h-14 flex flex-col items-center justify-center gap-1 ${w?"bg-red-500/90 hover:bg-red-600/90":"bg-white/10 hover:bg-white/20"}`,onClick:de,children:[w?e.jsx(ze,{className:"h-5 w-5"}):e.jsx(Ie,{className:"h-5 w-5"}),e.jsx("span",{className:"text-[10px] font-medium",children:w?"Video On":"Video Off"})]}),e.jsxs(h,{variant:"ghost",className:"rounded-full w-14 h-14 flex flex-col items-center justify-center gap-1 bg-red-500/90 hover:bg-red-600/90",onClick:ue,children:[e.jsx(Pe,{className:"h-5 w-5 transform rotate-135"}),e.jsx("span",{className:"text-[10px] font-medium",children:"End"})]}),e.jsxs(h,{variant:"ghost",className:`rounded-full w-14 h-14 flex flex-col items-center justify-center gap-1 ${I?"bg-blue-500/90 hover:bg-blue-600/90":"bg-white/10 hover:bg-white/20"}`,onClick:()=>W(!I),children:[e.jsx(Le,{className:"h-5 w-5"}),e.jsx("span",{className:"text-[10px] font-medium",children:"Chat"})]}),e.jsxs(Se,{children:[e.jsx(Ee,{asChild:!0,children:e.jsxs(h,{variant:"ghost",className:"rounded-full w-14 h-14 flex flex-col items-center justify-center gap-1 bg-white/10 hover:bg-white/20",children:[e.jsx(Re,{className:"h-5 w-5"}),e.jsx("span",{className:"text-[10px] font-medium",children:"More"})]})}),e.jsxs(Ce,{className:"bg-white dark:bg-gray-900 rounded-xl",children:[e.jsx(Te,{children:e.jsx($e,{className:"text-center",children:"Session Notes"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("h3",{className:"text-sm font-medium text-center",children:["Session with Dr. ",c.firstName," ",c.lastName]}),e.jsx("p",{className:"text-xs text-gray-500 text-center",children:"These notes will be saved to your health record."})]}),e.jsx(De,{placeholder:"Write your session notes here...",className:"min-h-[150px] bg-gray-50 dark:bg-gray-800 rounded-lg border-0 shadow-inner"}),e.jsx("div",{className:"flex justify-center pt-2",children:e.jsx(h,{className:"bg-primary-dark hover:bg-opacity-90 rounded-full px-6 py-2",children:"Save Notes"})})]})]})]})]})]}):e.jsxs("div",{className:"min-h-screen bg-primary flex flex-col items-center justify-center p-4",children:[e.jsx("div",{className:"text-amber-500 text-5xl mb-4",children:"🔐"}),e.jsx("h1",{className:"text-2xl font-bold text-secondary mb-2",children:"Login Necessário"}),e.jsx("p",{className:"text-primary-dark mb-4 text-center",children:"Por favor, faça login para acessar a sala de videoconsulta."}),e.jsx(h,{className:"bg-primary-dark hover:bg-secondary",onClick:()=>j("/auth"),children:"Fazer Login"}),e.jsx(h,{variant:"outline",className:"mt-2",onClick:()=>j("/"),children:"Voltar para Página Inicial"})]})}export{Ge as default};
